# LogHelper 日志系统

## 项目概述

LogHelper 是一个轻量级、高性能的.NET日志记录框架，专为.NET应用程序设计。它提供了简单易用的API，支持多种日志输出目标（文件、控制台、内存），可配置的日志级别，以及高效的文件轮转和压缩功能。

## 系统架构

### 整体架构

LogHelper采用了模块化和可扩展的架构设计，主要组件包括：

1. **LogHelper类** - 提供简化的日志API，是用户代码与日志系统的主要接口
2. **Log核心** - 负责日志的处理和分发
3. **LogSink** - 抽象的日志接收器基类
4. **具体日志接收器** - 包括文件、控制台和内存等多种实现
5. **LogMessage** - 统一的日志消息结构

系统采用了面向接口的设计，通过ILogSink接口定义日志接收器的行为，使得扩展新的日志接收器变得简单。

### 核心组件

1. **LogHelper** - 静态门面类，提供简化的API接口
2. **Log** - 核心日志处理引擎，负责将日志分发到各个接收器
3. **LogSink** - 抽象基类，定义日志接收器的共同行为
4. **FileLogSink** - 文件日志接收器，支持日志文件轮转和压缩
5. **ConsoleLogSink** - 控制台日志接收器，将日志输出到控制台
6. **MemoryLogSink** - 内存日志接收器，在内存中保存日志
7. **LogCategory** - 日志级别定义（Debug, Information, Warning, Error等）
8. **LogMessage** - 日志消息结构，包含时间戳、来源、消息等信息

## 架构图

### 1. 模块分层图

```
+---------------------------+
|      用户应用程序          |
+---------------------------+
             |
             v
+---------------------------+
|         LogHelper         | 静态外观类，提供简化API
+---------------------------+
             |
             v
+---------------------------+
|        Log 核心           | 核心日志引擎，处理和分发日志
+---------------------------+
             |
             v
+---------------------------+
|        LogSink 基类       | 抽象基类，定义接收器行为
+---------------------------+
     /        |        \
    /         |         \
   v          v          v
+-------+ +--------+ +--------+
|文件日志| |控制台日志| |内存日志 |
|接收器  | |接收器   | |接收器   |
+-------+ +--------+ +--------+
```

模块分层图显示了LogHelper系统的层次结构：
- 最顶层是用户应用程序，通过LogHelper类与日志系统交互
- LogHelper类作为外观(Facade)模式的实现，简化了API的使用
- Log核心层负责处理日志消息并将其分发到各个接收器
- LogSink基类定义了所有日志接收器的共同接口和行为
- 最底层是具体的日志接收器实现，负责将日志写入到不同的目标

### 2. 数据流图

```
+-------------+        LogMessage        +----------------+
|             |------------------------->|                |
| 用户应用程序  |                          |    LogHelper   |
|             |                          |                |
+-------------+                          +----------------+
                                                |
                                                | LogMessage
                                                v
                     +------------------------------+
                     |                              |
                     |            Log 核心           |
                     |                              |
                     +------------------------------+
                        |          |           |
                        | LogMessage LogMessage LogMessage
                        v          v           v
            +-----------+  +----------+  +-----------+
            |           |  |          |  |           |
            | FileLogSink|  |ConsoleLog|  |MemoryLog |
            |           |  |  Sink    |  |  Sink    |
            +-----------+  +----------+  +-----------+
                 |
                 | 格式化日志
                 v
        +------------------+
        |                  |
        | 日志文件(.log/.gz) |
        |                  |
        +------------------+
```

数据流图展示了LogHelper系统中日志消息的流动路径：

1. **生成阶段**：用户应用程序通过LogHelper API创建日志消息
2. **处理阶段**：
   - LogHelper将日志消息转发给Log核心
   - Log核心根据日志类别和启用状态过滤日志
   - Log核心将日志消息分发给所有注册的日志接收器
3. **输出阶段**：
   - FileLogSink将日志写入文件系统，支持文件轮转和压缩
   - ConsoleLogSink将日志输出到控制台，支持彩色显示
   - MemoryLogSink将日志保存在内存中，可用于实时监控

整个数据流是单向的，从用户应用程序流向不同的日志存储目标。系统采用了发布-订阅模式，使日志产生者与消费者解耦。

### 3. 依赖结构图

```
+------------------+     使用    +--------------------+
| 用户应用程序      | ----------> |     LogHelper      |
+------------------+            +--------------------+
                                         |
                                         | 依赖
                                         v
                                +--------------------+
                                |        Log        |
                                +--------------------+
                                         |
                                         | 使用
                                         v
                   +------------+--------------------+------------+
                   |            |                    |            |
                   v            v                    v            v
          +----------------+ +-------+     +------------------+ +--------+
          |   ILogSink接口 | |LogSink|     |   LogCategory   | |LogMessage|
          +----------------+ +-------+     +------------------+ +--------+
                   ^            ^
                   |            |
                   |            | 继承
        +----------+------------+----------+
        |          |            |          |
        v          v            v          v
+---------------+ +-------------+ +----------------+
| ConsoleLogSink| | FileLogSink | | MemoryLogSink |
+---------------+ +-------------+ +----------------+
```

依赖结构图显示了系统组件之间的依赖关系：

1. **接口依赖**：
   - 所有日志接收器实现ILogSink接口，确保接口一致性
   - LogSink基类实现ILogSink接口，提供基础实现

2. **继承关系**：
   - ConsoleLogSink、FileLogSink和MemoryLogSink都继承自LogSink

3. **组合关系**：
   - Log核心使用LogMessage表示日志内容
   - Log核心使用LogCategory区分日志级别
   - LogHelper作为门面依赖Log核心功能

4. **外部依赖**：
   - 日志系统依赖.NET Framework的IO操作
   - FileLogSink依赖文件系统
   - 用于GZ压缩的功能依赖System.IO.Compression

这种设计使系统具有高度的模块化和可扩展性，同时确保了组件之间的低耦合。

### 4. 数据模型图

```
+---------------------------------------------------+
|                    LogMessage                     |
+---------------------------------------------------+
| + UtcTimestamp: long                             |
| + Microseconds: long                             |
| + ThreadId: string                               |
| + SourceProcess: string                          |
| + Source: string                                 |
| + Type: string                                   |
| + Category: LogCategory                          |
| + Message: string                                |
+---------------------------------------------------+
| + Serialize(): string                            |
| + Deserialize(string): LogMessage                |
+---------------------------------------------------+
                      ^
                      |
                      | 使用
                      |
+---------------------------------------------------+
|                    LogCategory (枚举)              |
+---------------------------------------------------+
| + Debug = 0x0001                                 |
| + Information = 0x0002                           |
| + Warning = 0x0004                               |
| + Error = 0x0008                                 |
| + All = 0x000F                                   |
+---------------------------------------------------+
                      ^
                      |
                      | 使用
                      |
+---------------------------------------------------+
|                     ILogSink                      |
+---------------------------------------------------+
| + EnabledCategories: LogCategory                 |
| + Write(LogMessage): bool                        |
+---------------------------------------------------+
                      ^
                      |
                      | 实现
                      |
+---------------------------------------------------+
|                     LogSink                       |
+---------------------------------------------------+
| + EnabledCategories: LogCategory                 |
| + Write(LogMessage): bool                        |
| # DoWrite(LogMessage): bool                      |
+---------------------------------------------------+
                      ^
                      |
                      | 继承
          +------------------------+
          |                        |
+-----------------+    +-------------------------+
|  ConsoleLogSink |    |      FileLogSink       |
+-----------------+    +-------------------------+
| + Write()       |    | + BaseDirectory: string |
+-----------------+    | + MaxFileSize: long     |
                       | + MaxDaysOld: int       |
                       | + EnableCompression: bool|
                       | + 文件和压缩操作方法     |
                       +-------------------------+
```

数据模型图展示了LogHelper系统中的主要数据结构及其关系：

1. **LogMessage**：
   - 包含完整的日志信息，如时间戳、线程ID、来源、消息等
   - 提供序列化/反序列化方法，用于日志的存储和传输

2. **LogCategory**：
   - 枚举类型，定义日志级别（Debug、Information、Warning、Error）
   - 支持位标志操作，可组合多种级别

3. **ILogSink**：
   - 定义日志接收器的接口，包含启用的日志类别和写入方法
   - 所有具体的日志接收器都实现此接口

4. **LogSink**：
   - 抽象基类，提供ILogSink的基本实现
   - 定义了DoWrite抽象方法，由子类实现具体写入逻辑

5. **具体日志接收器**：
   - ConsoleLogSink：负责控制台输出
   - FileLogSink：负责文件写入，包含文件管理相关属性和压缩功能

数据模型设计遵循了面向对象的原则，通过继承和组合实现功能复用，同时保持了良好的扩展性。

### 5. API使用时序图

```
+------------+      +------------+        +---------+     +---------------+     +-------------------+
| 应用程序    |      | LogHelper  |        | Log核心  |     | 日志接收器集合  |     | 具体日志接收器     |
+------------+      +------------+        +---------+     +---------------+     +-------------------+
      |                   |                   |                  |                       |
      | 1. Initialize()   |                   |                  |                       |
      |------------------>|                   |                  |                       |
      |                   | 2. 创建日志接收器    |                  |                       |
      |                   |------------------>|                  |                       |
      |                   |                   | 3. Add(sink)     |                       |
      |                   |                   |----------------->|                       |
      |                   |                   |                  | 4. 添加到集合           |
      |                   |                   |                  |---------------------->|
      |                   |                   |                  |                       |
      | 5. Info/Debug/... |                   |                  |                       |
      |------------------>|                   |                  |                       |
      |                   | 6. WriteIfEnabled |                  |                       |
      |                   |------------------>|                  |                       |
      |                   |                   | 7. 检查日志级别    |                       |
      |                   |                   |------------------>                       |
      |                   |                   | 8. 创建LogMessage |                       |
      |                   |                   |------------------>                       |
      |                   |                   | 9. 获取所有接收器   |                       |
      |                   |                   |----------------->|                       |
      |                   |                   |                  | 10. 返回接收器集合       |
      |                   |                   |<-----------------|                       |
      |                   |                   | 11. Write(msg)   |                       |
      |                   |                   |---------------------------------------->|
      |                   |                   |                  |                       |
      |                   |                   |                  |                       | 12. DoWrite(msg)
      |                   |                   |                  |                       |---------------->
      |                   |                   |                  |                       | 13. 实际写入操作
      |                   |                   |                  |                       |
      | 14. 返回          |                   |                  |                       |
      |<------------------|                   |                  |                       |
      |                   |                   |                  |                       |
      | 15. Shutdown()    |                   |                  |                       |
      |------------------>|                   |                  |                       |
      |                   | 16. Shutdown()    |                  |                       |
      |                   |------------------>|                  |                       |
      |                   |                   | 17. 关闭所有接收器 |                       |
      |                   |                   |----------------->|                       |
      |                   |                   |                  | 18. 执行清理           |
      |                   |                   |                  |---------------------->|
      |                   |                   |                  |                       | 19. Dispose()
      |                   |                   |                  |                       |
```

API使用时序图展示了LogHelper系统的关键操作流程和组件交互：

1. **初始化流程（1-4）**：
   - 应用程序调用LogHelper.Initialize()
   - LogHelper创建所需的日志接收器
   - 日志接收器注册到Log核心的接收器集合中

2. **日志记录流程（5-14）**：
   - 应用程序调用LogHelper的日志记录方法（如Info、Debug等）
   - LogHelper调用Log.WriteIfEnabled检查日志级别
   - Log核心创建LogMessage对象
   - Log核心获取所有启用的日志接收器
   - 日志消息分发到各个接收器的Write方法
   - 各接收器执行DoWrite完成实际写入操作

3. **关闭流程（15-19）**：
   - 应用程序调用LogHelper.Shutdown()
   - LogHelper调用Log.Shutdown()
   - Log核心关闭所有日志接收器
   - 执行必要的清理操作（如文件日志的Dispose）

此时序图展示了系统各组件间的通信和协作方式，清晰表达了日志系统的工作流程。

### 6. 状态转换图

```
                       +----------------+
                       |                |
                       |    未初始化     |
                       |                |
                       +----------------+
                               |
                               | LogHelper.Initialize()
                               v
              +--------------------------------+
              |                                |
              |          初始化完成            |
              |   (日志接收器已配置并启用)      |
              |                                |
              +--------------------------------+
                 |            |            |
                 |            |            |
   LogHelper.Info/|            |     日志存储满或  |
   Debug/Error等  |            |     达到时间阈值  |
                 |            |            |
                 v            v            v
  +---------------+  +------------------+  +--------------------+
  |               |  |                  |  |                    |
  | 日志消息处理中  |  | 日志过滤中(基于  |  | 日志文件轮转/关闭  |
  |               |  | 日志级别和类别)   |  |                    |
  +---------------+  +------------------+  +--------------------+
         |                   |                     |
         v                   v                     v
  +---------------+  +------------------+  +--------------------+
  |               |  |                  |  |                    |
  | 日志写入接收器  |  |   丢弃不符日志   |  |   创建新日志文件   |
  |               |  |                  |  |                    |
  +---------------+  +------------------+  +--------------------+
         |                                          |
         \------------------------------------------+
                              |
                              | LogHelper.Shutdown()
                              v
                    +--------------------+
                    |                    |
                    |     系统关闭中      |
                    | (清理和资源释放)    |
                    |                    |
                    +--------------------+
                              |
                              | 资源释放完成
                              v
                    +--------------------+
                    |                    |
                    |     系统已关闭      |
                    |                    |
                    +--------------------+
```

状态转换图展示了LogHelper系统的主要状态及其转换过程：

1. **未初始化状态**：
   - 系统初始状态，日志功能不可用
   - 通过LogHelper.Initialize()进入初始化完成状态

2. **初始化完成状态**：
   - 日志系统已配置，接收器已准备就绪
   - 可以接收和处理日志消息

3. **日志处理状态**：
   - 日志消息处理中：正在处理应用程序发送的日志消息
   - 日志过滤中：根据日志级别和类别过滤不需要的日志
   - 日志文件轮转/关闭：当文件达到大小限制或时间阈值时发生

4. **日志输出状态**：
   - 日志写入接收器：将符合条件的日志写入到目标接收器
   - 丢弃不符日志：过滤掉不符合级别要求的日志
   - 创建新日志文件：在文件轮转后创建新的日志文件

5. **系统关闭状态**：
   - 通过LogHelper.Shutdown()进入关闭状态
   - 清理资源并释放所有接收器
   - 完成所有清理后进入系统已关闭状态

此状态图反映了日志系统的生命周期和运行过程中的主要状态变化，有助于理解系统的工作机制。

## 使用方法

### 初始化日志系统

```csharp
// 使用默认设置初始化
LogHelper.Initialize("MyApplication");

// 使用自定义设置初始化
LogHelper.Initialize(
    applicationName: "MyApplication",  // 应用程序名称
    logDirectory: "Logs",             // 日志目录
    enabledCategories: LogCategory.All, // 启用所有日志级别
    maxFileSize: 10 * 1024 * 1024,    // 最大文件大小（10MB）
    maxDaysOld: 30,                   // 日志保留天数
    logToConsole: true,               // 同时输出到控制台
    enableCompression: true           // 启用日志文件压缩
);
```

### 记录日志

```csharp
// 记录不同级别的日志
LogHelper.Debug("Module1", "这是一条调试信息");
LogHelper.Info("Module1", "这是一条普通信息");
LogHelper.Warning("Module1", "这是一条警告信息");
LogHelper.Error("Module1", "这是一条错误信息");

// 使用格式化字符串
LogHelper.Info("Module1", "用户 {0} 登录成功，角色: {1}", userName, role);

// 记录异常
try {
    // 可能抛出异常的代码
}
catch (Exception ex) {
    LogHelper.Exception("Module1", ex, "操作失败");
}
```

### 使用内存日志

```csharp
// 添加内存日志接收器
MemoryLogSink memorySink = LogHelper.AddMemoryLogger(1000); // 最多保存1000条消息

// 注册新消息事件处理程序
memorySink.NewMessageAdded += (sender, message) => {
    // 处理新添加的日志消息
};

// 获取内存中的所有日志
LogMessage[] messages = memorySink.GetMessages();
```

### 关闭日志系统

```csharp
// 在应用程序退出前关闭日志系统
LogHelper.Shutdown();
``` 